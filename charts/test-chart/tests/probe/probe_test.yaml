suite: Test probe template
templates:
  - template.yaml

tests:
  - it: should create basic Probe correctly
    values:
      - probe_values.yaml
    asserts:
      - equal:
          path: kind
          value: Probe
      - equal:
          path: apiVersion
          value: monitoring.coreos.com/v1
      - equal:
          path: metadata.name
          value: test-probe
      - equal:
          path: metadata.namespace
          value: test-namespace

  - it: should not render Probe if disabled
    values:
      - probe_values.yaml
    set:
      probes.test-probe.disabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should set prober url correctly
    values:
      - probe_values.yaml
    asserts:
      - equal:
          path: spec.prober.url
          value: "blackbox-exporter.monitoring:9115"

  - it: should set static targets correctly
    values:
      - probe_values.yaml
    asserts:
      - equal:
          path: spec.targets.staticConfig.static[0]
          value: https://example.com
      - equal:
          path: spec.targets.staticConfig.static[1]
          value: https://example.org

  - it: should set default interval and scrapeTimeout
    values:
      - probe_values.yaml
    asserts:
      - equal:
          path: spec.interval
          value: 30s
      - equal:
          path: spec.scrapeTimeout
          value: 10s

  - it: should set prober config options
    set:
      probes:
        test-probe:
          name: test-probe
          namespace: test-namespace
          prober:
            url: blackbox-exporter.monitoring:9115
            scheme: https
            path: /custom-probe
            proxyUrl: http://proxy:8080
          targets:
            staticConfig:
              static:
                - https://example.com
    asserts:
      - equal:
          path: spec.prober.scheme
          value: https
      - equal:
          path: spec.prober.path
          value: /custom-probe
      - equal:
          path: spec.prober.proxyUrl
          value: "http://proxy:8080"

  - it: should set module
    values:
      - probe_values.yaml
    set:
      probes.test-probe.module: http_2xx
    asserts:
      - equal:
          path: spec.module
          value: http_2xx

  - it: should set jobName
    values:
      - probe_values.yaml
    set:
      probes.test-probe.jobName: blackbox
    asserts:
      - equal:
          path: spec.jobName
          value: blackbox

  - it: should set custom interval and scrapeTimeout
    values:
      - probe_values.yaml
    set:
      probes.test-probe.interval: 60s
      probes.test-probe.scrapeTimeout: 30s
    asserts:
      - equal:
          path: spec.interval
          value: 60s
      - equal:
          path: spec.scrapeTimeout
          value: 30s

  - it: should set sampleLimit and targetLimit
    values:
      - probe_values.yaml
    set:
      probes.test-probe.sampleLimit: 5000
      probes.test-probe.targetLimit: 100
    asserts:
      - equal:
          path: spec.sampleLimit
          value: 5000
      - equal:
          path: spec.targetLimit
          value: 100

  - it: should set metricRelabelings
    values:
      - probe_values.yaml
    set:
      probes.test-probe.metricRelabelings:
        - sourceLabels: [__name__]
          regex: "probe_.*"
          action: keep
    asserts:
      - equal:
          path: spec.metricRelabelings[0].action
          value: keep

  - it: should set custom labels and annotations
    values:
      - probe_values.yaml
    set:
      probes.test-probe.labels:
        custom-label: test-value
      probes.test-probe.annotations:
        custom-annotation: test-annotation
    asserts:
      - equal:
          path: metadata.labels["custom-label"]
          value: test-value
      - equal:
          path: metadata.annotations["custom-annotation"]
          value: test-annotation
