suite: Test podmonitor template
templates:
  - template.yaml

tests:
  - it: should create basic PodMonitor correctly
    values:
      - podmonitor_values.yaml
    asserts:
      - equal:
          path: kind
          value: PodMonitor
      - equal:
          path: apiVersion
          value: monitoring.coreos.com/v1
      - equal:
          path: metadata.name
          value: test-podmonitor
      - equal:
          path: metadata.namespace
          value: test-namespace

  - it: should set selector matchLabels correctly
    values:
      - podmonitor_values.yaml
    asserts:
      - equal:
          path: spec.selector.matchLabels.app
          value: my-app

  - it: should set default namespaceSelector
    values:
      - podmonitor_values.yaml
    asserts:
      - equal:
          path: spec.namespaceSelector.matchNames[0]
          value: test-namespace

  - it: should set podMetricsEndpoint defaults
    values:
      - podmonitor_values.yaml
    asserts:
      - equal:
          path: spec.podMetricsEndpoints[0].port
          value: http-metrics
      - equal:
          path: spec.podMetricsEndpoints[0].path
          value: /metrics
      - equal:
          path: spec.podMetricsEndpoints[0].interval
          value: 30s
      - equal:
          path: spec.podMetricsEndpoints[0].scrapeTimeout
          value: 10s

  - it: should not render PodMonitor if disabled
    values:
      - podmonitor_values.yaml
    set:
      podMonitors.test-pm.disabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should set custom labels and annotations
    values:
      - podmonitor_values.yaml
    set:
      podMonitors.test-pm.labels:
        custom-label: test-value
      podMonitors.test-pm.annotations:
        custom-annotation: test-annotation
    asserts:
      - equal:
          path: metadata.labels["custom-label"]
          value: test-value
      - equal:
          path: metadata.annotations["custom-annotation"]
          value: test-annotation

  - it: should set jobLabel
    values:
      - podmonitor_values.yaml
    set:
      podMonitors.test-pm.jobLabel: my-job
    asserts:
      - equal:
          path: spec.jobLabel
          value: my-job

  - it: should set podTargetLabels
    values:
      - podmonitor_values.yaml
    set:
      podMonitors.test-pm.podTargetLabels:
        - pod
    asserts:
      - equal:
          path: spec.podTargetLabels[0]
          value: pod

  - it: should set sampleLimit and targetLimit
    values:
      - podmonitor_values.yaml
    set:
      podMonitors.test-pm.sampleLimit: 5000
      podMonitors.test-pm.targetLimit: 100
    asserts:
      - equal:
          path: spec.sampleLimit
          value: 5000
      - equal:
          path: spec.targetLimit
          value: 100

  - it: should set tlsConfig on podMetricsEndpoint
    values:
      - podmonitor_values.yaml
    set:
      podMonitors.test-pm.podMetricsEndpoints:
        - port: http-metrics
          tlsConfig:
            insecureSkipVerify: true
    asserts:
      - equal:
          path: spec.podMetricsEndpoints[0].tlsConfig.insecureSkipVerify
          value: true

  - it: should set bearerTokenSecret on podMetricsEndpoint
    values:
      - podmonitor_values.yaml
    set:
      podMonitors.test-pm.podMetricsEndpoints:
        - port: http-metrics
          bearerTokenSecret:
            name: token-secret
            key: token
    asserts:
      - equal:
          path: spec.podMetricsEndpoints[0].bearerTokenSecret.name
          value: token-secret

  - it: should set honorLabels on podMetricsEndpoint
    values:
      - podmonitor_values.yaml
    set:
      podMonitors.test-pm.podMetricsEndpoints:
        - port: http-metrics
          honorLabels: true
    asserts:
      - equal:
          path: spec.podMetricsEndpoints[0].honorLabels
          value: true

  - it: should set filterRunning on podMetricsEndpoint
    values:
      - podmonitor_values.yaml
    set:
      podMonitors.test-pm.podMetricsEndpoints:
        - port: http-metrics
          filterRunning: true
    asserts:
      - equal:
          path: spec.podMetricsEndpoints[0].filterRunning
          value: true

  - it: should override namespaceSelector
    values:
      - podmonitor_values.yaml
    set:
      podMonitors.test-pm.namespaceSelector:
        any: true
    asserts:
      - equal:
          path: spec.namespaceSelector.any
          value: true

  - it: should set metricRelabelings on podMetricsEndpoint
    values:
      - podmonitor_values.yaml
    set:
      podMonitors.test-pm.podMetricsEndpoints:
        - port: http-metrics
          metricRelabelings:
            - sourceLabels: [__name__]
              regex: "expensive_metric_.*"
              action: drop
    asserts:
      - equal:
          path: spec.podMetricsEndpoints[0].metricRelabelings[0].action
          value: drop

  - it: should set custom endpoint path and interval
    values:
      - podmonitor_values.yaml
    set:
      podMonitors.test-pm.podMetricsEndpoints:
        - port: http-metrics
          path: /custom-metrics
          interval: 60s
          scrapeTimeout: 30s
    asserts:
      - equal:
          path: spec.podMetricsEndpoints[0].path
          value: /custom-metrics
      - equal:
          path: spec.podMetricsEndpoints[0].interval
          value: 60s
      - equal:
          path: spec.podMetricsEndpoints[0].scrapeTimeout
          value: 30s
