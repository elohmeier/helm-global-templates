suite: Test servicemonitor template
templates:
  - template.yaml

tests:
  - it: should create basic ServiceMonitor correctly
    values:
      - servicemonitor_values.yaml
    asserts:
      - equal:
          path: kind
          value: ServiceMonitor
      - equal:
          path: apiVersion
          value: monitoring.coreos.com/v1
      - equal:
          path: metadata.name
          value: test-servicemonitor
      - equal:
          path: metadata.namespace
          value: test-namespace

  - it: should set selector matchLabels correctly
    values:
      - servicemonitor_values.yaml
    asserts:
      - equal:
          path: spec.selector.matchLabels.app
          value: my-app

  - it: should set default namespaceSelector
    values:
      - servicemonitor_values.yaml
    asserts:
      - equal:
          path: spec.namespaceSelector.matchNames[0]
          value: test-namespace

  - it: should set endpoint defaults
    values:
      - servicemonitor_values.yaml
    asserts:
      - equal:
          path: spec.endpoints[0].port
          value: http-metrics
      - equal:
          path: spec.endpoints[0].path
          value: /metrics
      - equal:
          path: spec.endpoints[0].interval
          value: 30s
      - equal:
          path: spec.endpoints[0].scrapeTimeout
          value: 10s

  - it: should not render ServiceMonitor if disabled
    values:
      - servicemonitor_values.yaml
    set:
      servicemonitors.test-sm.disabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should set custom labels and annotations
    values:
      - servicemonitor_values.yaml
    set:
      servicemonitors.test-sm.labels:
        custom-label: test-value
      servicemonitors.test-sm.annotations:
        custom-annotation: test-annotation
    asserts:
      - equal:
          path: metadata.labels["custom-label"]
          value: test-value
      - equal:
          path: metadata.annotations["custom-annotation"]
          value: test-annotation

  - it: should set jobLabel
    values:
      - servicemonitor_values.yaml
    set:
      servicemonitors.test-sm.jobLabel: my-job
    asserts:
      - equal:
          path: spec.jobLabel
          value: my-job

  - it: should set targetLabels
    values:
      - servicemonitor_values.yaml
    set:
      servicemonitors.test-sm.targetLabels:
        - instance
        - job
    asserts:
      - equal:
          path: spec.targetLabels[0]
          value: instance
      - equal:
          path: spec.targetLabels[1]
          value: job

  - it: should set podTargetLabels
    values:
      - servicemonitor_values.yaml
    set:
      servicemonitors.test-sm.podTargetLabels:
        - pod
    asserts:
      - equal:
          path: spec.podTargetLabels[0]
          value: pod

  - it: should set sampleLimit and targetLimit
    values:
      - servicemonitor_values.yaml
    set:
      servicemonitors.test-sm.sampleLimit: 5000
      servicemonitors.test-sm.targetLimit: 100
    asserts:
      - equal:
          path: spec.sampleLimit
          value: 5000
      - equal:
          path: spec.targetLimit
          value: 100

  - it: should set attachMetadata
    values:
      - servicemonitor_values.yaml
    set:
      servicemonitors.test-sm.attachMetadata:
        node: true
    asserts:
      - equal:
          path: spec.attachMetadata.node
          value: true

  - it: should support selector with matchExpressions
    set:
      servicemonitors:
        test-sm:
          name: test-servicemonitor
          namespace: test-namespace
          selector:
            matchLabels:
              app: my-app
            matchExpressions:
              - key: tier
                operator: In
                values:
                  - frontend
                  - backend
          endpoints:
            - port: http-metrics
    asserts:
      - equal:
          path: spec.selector.matchLabels.app
          value: my-app
      - equal:
          path: spec.selector.matchExpressions[0].key
          value: tier
      - equal:
          path: spec.selector.matchExpressions[0].operator
          value: In

  - it: should override namespaceSelector
    values:
      - servicemonitor_values.yaml
    set:
      servicemonitors.test-sm.namespaceSelector:
        any: true
    asserts:
      - equal:
          path: spec.namespaceSelector.any
          value: true

  - it: should set honorLabels on endpoint
    values:
      - servicemonitor_values.yaml
    set:
      servicemonitors.test-sm.endpoints:
        - port: http-metrics
          honorLabels: true
    asserts:
      - equal:
          path: spec.endpoints[0].honorLabels
          value: true

  - it: should set honorTimestamps on endpoint
    values:
      - servicemonitor_values.yaml
    set:
      servicemonitors.test-sm.endpoints:
        - port: http-metrics
          honorTimestamps: true
    asserts:
      - equal:
          path: spec.endpoints[0].honorTimestamps
          value: true

  - it: should set tlsConfig on endpoint
    values:
      - servicemonitor_values.yaml
    set:
      servicemonitors.test-sm.endpoints:
        - port: http-metrics
          tlsConfig:
            insecureSkipVerify: true
            caFile: /etc/prom-certs/root-cert.pem
    asserts:
      - equal:
          path: spec.endpoints[0].tlsConfig.insecureSkipVerify
          value: true
      - equal:
          path: spec.endpoints[0].tlsConfig.caFile
          value: /etc/prom-certs/root-cert.pem

  - it: should set basicAuth on endpoint
    values:
      - servicemonitor_values.yaml
    set:
      servicemonitors.test-sm.endpoints:
        - port: http-metrics
          basicAuth:
            username:
              name: auth-secret
              key: username
            password:
              name: auth-secret
              key: password
    asserts:
      - equal:
          path: spec.endpoints[0].basicAuth.username.name
          value: auth-secret
      - equal:
          path: spec.endpoints[0].basicAuth.password.key
          value: password

  - it: should set bearerTokenSecret on endpoint
    values:
      - servicemonitor_values.yaml
    set:
      servicemonitors.test-sm.endpoints:
        - port: http-metrics
          bearerTokenSecret:
            name: token-secret
            key: token
    asserts:
      - equal:
          path: spec.endpoints[0].bearerTokenSecret.name
          value: token-secret

  - it: should set filterRunning on endpoint
    values:
      - servicemonitor_values.yaml
    set:
      servicemonitors.test-sm.endpoints:
        - port: http-metrics
          filterRunning: true
    asserts:
      - equal:
          path: spec.endpoints[0].filterRunning
          value: true

  - it: should set custom endpoint path and interval
    values:
      - servicemonitor_values.yaml
    set:
      servicemonitors.test-sm.endpoints:
        - port: http-metrics
          path: /custom-metrics
          interval: 60s
          scrapeTimeout: 30s
    asserts:
      - equal:
          path: spec.endpoints[0].path
          value: /custom-metrics
      - equal:
          path: spec.endpoints[0].interval
          value: 60s
      - equal:
          path: spec.endpoints[0].scrapeTimeout
          value: 30s

  - it: should set metricRelabelings on endpoint
    values:
      - servicemonitor_values.yaml
    set:
      servicemonitors.test-sm.endpoints:
        - port: http-metrics
          metricRelabelings:
            - sourceLabels: [__name__]
              regex: "expensive_metric_.*"
              action: drop
    asserts:
      - equal:
          path: spec.endpoints[0].metricRelabelings[0].action
          value: drop

  - it: should set relabelings on endpoint
    values:
      - servicemonitor_values.yaml
    set:
      servicemonitors.test-sm.endpoints:
        - port: http-metrics
          relabelings:
            - sourceLabels: [__meta_kubernetes_pod_label_app]
              targetLabel: app
    asserts:
      - equal:
          path: spec.endpoints[0].relabelings[0].targetLabel
          value: app
